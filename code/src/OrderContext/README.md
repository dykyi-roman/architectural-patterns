# Контекст заказов (OrderContext)

## Единый язык (Ubiquitous Language)

Данный документ описывает термины и концепции, используемые в контексте заказов. Единый язык помогает разработчикам и предметным экспертам говорить на одном языке и избегать недопонимания.

### Основные концепции и сущности

#### Заказ (Order)
Центральная сущность в нашей предметной области. Заказ создается клиентом и содержит набор товаров. Заказ имеет уникальный идентификатор, статус и общую стоимость. Заказ является агрегатом (корнем агрегации) и инкапсулирует всю логику, связанную с его жизненным циклом.

#### Элемент заказа (OrderItem)
Составная часть заказа, представляющая конкретный товар в определенном количестве и по определенной цене. Элемент заказа всегда принадлежит конкретному заказу и не может существовать отдельно от него.

#### Идентификатор заказа (OrderId)
Уникальный идентификатор заказа, представленный в формате UUID. Используется для однозначной идентификации заказа в системе.

#### Идентификатор клиента (CustomerId)
Уникальный идентификатор клиента, которому принадлежит заказ. Представлен в формате UUID.

#### Идентификатор товара (ProductId)
Уникальный идентификатор товара, который включен в заказ. Представлен в формате UUID.

#### Деньги (Money)
Денежная сумма, состоящая из числового значения (amount) и валюты (currency). Используется для представления цен товаров и общей стоимости заказа.

#### Статус заказа (OrderStatus)
Состояние заказа в его жизненном цикле. Заказ может находиться в следующих состояниях:
- **Создан (created)**: начальное состояние после создания заказа
- **В обработке (processing)**: заказ принят и обрабатывается
- **Завершен (completed)**: обработка заказа завершена, готов к отправке
- **Отправлен (shipped)**: заказ отправлен клиенту
- **Доставлен (delivered)**: заказ успешно доставлен клиенту
- **Отменен (cancelled)**: заказ был отменен

### События домена

#### Событие создания заказа (OrderCreatedEvent)
Событие, которое генерируется при создании нового заказа. Содержит информацию о созданном заказе, включая его идентификатор, идентификатор клиента, элементы заказа и общую стоимость.

#### Событие изменения статуса заказа (OrderStatusChangedEvent)
Событие, которое генерируется при изменении статуса заказа. Содержит информацию о идентификаторе заказа, предыдущем и новом статусах.

### Репозитории

#### Репозиторий заказов (OrderRepository)
Отвечает за сохранение и получение заказов из постоянного хранилища. Используется для операций записи в модели CQRS.

#### Репозиторий модели чтения заказов (OrderReadModelRepository)
Отвечает за получение данных о заказах из хранилища, оптимизированного для чтения. Используется для операций чтения в модели CQRS.

### Архитектурные компоненты

#### Случаи использования (UseCases)
Центральные компоненты архитектуры приложения, реализующие конкретные бизнес-сценарии. Каждый UseCase представляет собой отдельный модуль, содержащий команду/запрос и соответствующий обработчик. Основные случаи использования:

- **CreateOrder**: Создание нового заказа
- **ChangeOrderStatus**: Изменение статуса существующего заказа
- **GetOrder**: Получение детальной информации о заказе
- **GetOrdersList**: Получение списка заказов с фильтрацией и пагинацией

#### Служба приложения заказов (OrderApplicationService)
Координирует выполнение операций над заказами, обеспечивая единую точку входа для юз-кейсов. Делегирует выполнение команд и запросов соответствующим обработчикам через шину сообщений или напрямую.

#### API Action-контроллеры
Входные точки REST API, которые принимают HTTP-запросы, преобразуют их в соответствующие команды или запросы и передают в OrderApplicationService для выполнения:

- **CreateOrderAction**: Создание заказа через API
- **ChangeOrderStatusAction**: Изменение статуса заказа через API
- **GetOrderAction**: Получение информации о заказе через API
- **GetOrdersListAction**: Получение списка заказов через API

### Команды и запросы (CQRS)

#### Команда создания заказа (CreateOrderCommand)
Команда для создания нового заказа. Содержит информацию, необходимую для создания заказа: идентификатор клиента и список товаров. Обрабатывается CreateOrderCommandHandler.

#### Команда изменения статуса заказа (ChangeOrderStatusCommand)
Команда для изменения статуса существующего заказа. Содержит идентификатор заказа и новый статус. Обрабатывается ChangeOrderStatusCommandHandler.

#### Запрос получения заказа (GetOrderQuery)
Запрос для получения информации о конкретном заказе по его идентификатору. Обрабатывается GetOrderQueryHandler.

#### Запрос получения списка заказов (GetOrdersListQuery)
Запрос для получения списка заказов с возможностью фильтрации по клиенту, статусу и другим параметрам. Поддерживает пагинацию и сортировку. Обрабатывается GetOrdersListQueryHandler.

### Интерфейсы контрактов

#### CommandInterface
Базовый интерфейс для всех команд в системе. Маркирует объект как команду, выполняющую операцию записи.

#### CommandHandlerInterface
Интерфейс для обработчиков команд. Определяет метод __invoke, принимающий команду и выполняющий соответствующую бизнес-логику.

#### QueryInterface
Базовый интерфейс для всех запросов в системе. Маркирует объект как запрос, выполняющий операцию чтения.

#### QueryHandlerInterface
Интерфейс для обработчиков запросов. Определяет метод __invoke, принимающий запрос и возвращающий результат.

### Инфраструктурные концепции

#### Хранилище событий (EventStore)
Компонент, отвечающий за хранение всех доменных событий, связанных с заказами.

#### Паттерн Outbox
Механизм, обеспечивающий надежную публикацию доменных событий во внешние системы после успешного завершения транзакции.

## Взаимодействия и процессы

### Создание заказа
1. Клиент отправляет запрос на создание заказа через API
2. CreateOrderAction преобразует запрос в CreateOrderCommand
3. OrderApplicationService передает команду в CreateOrderCommandHandler
4. Обработчик команды создает новый заказ и генерирует событие OrderCreatedEvent
5. Заказ сохраняется в репозитории заказов
6. Событие сохраняется в хранилище событий и публикуется через Outbox
7. Обработчик события обновляет модель чтения

### Изменение статуса заказа
1. Запрос на изменение статуса поступает через API
2. ChangeOrderStatusAction преобразует запрос в ChangeOrderStatusCommand
3. OrderApplicationService передает команду в ChangeOrderStatusCommandHandler
4. Обработчик команды изменяет статус заказа и генерирует событие OrderStatusChangedEvent
5. Обновленный заказ сохраняется в репозитории
6. Событие сохраняется в хранилище событий и публикуется через Outbox
7. Обработчик события обновляет модель чтения

### Получение информации о заказе
1. Клиент отправляет запрос на получение заказа через API
2. GetOrderAction преобразует запрос в GetOrderQuery
3. OrderApplicationService передает запрос в GetOrderQueryHandler
4. Обработчик запроса получает данные из репозитория модели чтения
5. Данные преобразуются в DTO и возвращаются клиенту

### Получение списка заказов
1. Клиент отправляет запрос на получение списка заказов с фильтрами через API
2. GetOrdersListAction преобразует запрос в GetOrdersListQuery
3. OrderApplicationService передает запрос в GetOrdersListQueryHandler
4. Обработчик запроса получает данные из репозитория модели чтения с учетом фильтров
5. Данные преобразуются в DTO с пагинацией и возвращаются клиенту

## Технологический стек

- **Язык программирования**: PHP 8.3 с declare(strict_types=1)
- **Фреймворк**: Symfony 7.2
- **Архитектурные паттерны**: DDD, CQRS, Clean Architecture
- **Шаблоны проектирования**: Repository, Factory, Value Object, Command/Query, Handler
- **Организация кода**: UseCases по бизнес-функциям